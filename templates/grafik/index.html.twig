{% extends planer_base_template %}

{% block title %}Grafik pracy{% endblock %}
{% block page_pretitle %}Grafik pracy{% endblock %}
{% block page_title %}
    {% if brakDepartamentu %}
        Grafik pracy
    {% else %}
        {{ miesiacNazwa }} {{ rok }}
    {% endif %}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .grafik-wrap { overflow-x: auto; }
        .grafik-table {
            font-size: 0.72rem; table-layout: fixed; width: 100%; border-collapse: collapse;
            height: auto !important;
        }
        .grafik-table th,
        .grafik-table td { text-align: center; vertical-align: middle; padding: 0 !important; border: 1px solid #dee2e6; box-shadow: none !important; }
        .grafik-table .col-name { text-align: left; width: 110px; min-width: 110px; max-width: 110px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; position: sticky; left: 0; background: #fff; z-index: 2; padding-left: 4px !important; font-size: 0.68rem; }
        .grafik-table thead th.col-name { z-index: 3; }
        .grafik-table thead th:not(.col-name) { padding: 2px 0 !important; }
        .grafik-table .weekend { background-color: #f0f0f0 !important; }
        .grafik-table .holiday { background-color: #fce4e4 !important; }
        .grafik-table .holiday-header .day-num { color: #d63939; }
        .grafik-table .holiday-header .day-name { color: #d63939; }
        .grafik-table .col-dw { width: 36px; min-width: 36px; max-width: 36px; background-color: #e8f4f8 !important; border-left: 2px solid #206bc4; }
        .grafik-table .dw-cell { font-weight: 700; color: #206bc4; }

        .grafik-cell { font-weight: 700; font-size: 0.65rem; line-height: 30px; height: 30px; user-select: none; text-align: center; position: relative; }
        .grafik-cell.has-podanie::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: #2fb344; border-radius: 0 0 2px 2px; }
        .grafik-cell.editable { cursor: pointer; }
        .grafik-cell.editable:hover { opacity: 0.8; }
        .grafik-cell.selected { box-shadow: inset 0 0 0 2px #206bc4 !important; background: rgba(32,107,196,0.15); }
        .grafik-cell.kbd-cursor { box-shadow: inset 0 0 0 2px #f76707 !important; background: rgba(247,103,7,0.12); }
        .grafik-table.is-dragging { user-select: none; cursor: crosshair; }
        .grafik-table.is-dragging .grafik-cell { cursor: crosshair; }

        .grafik-dropdown { position: fixed; z-index: 1000; background: #fff; border: 1px solid #dee2e6; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 4px 0; min-width: 160px; }
        .grafik-dropdown-header { padding: 5px 10px; font-size: 0.75rem; font-weight: 700; color: #206bc4; }
        .grafik-dropdown-item { display: flex; align-items: center; gap: 6px; padding: 4px 10px; cursor: pointer; font-size: 0.78rem; }
        .grafik-dropdown-item:hover { background: #f1f5f9; }
        .grafik-dropdown-item .color-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .grafik-dropdown-separator { height: 1px; background: #dee2e6; margin: 2px 0; }
        .grafik-dropdown-item.clear { color: #dc3545; }
        .grafik-dropdown-item.repeat { color: #206bc4; }
        .grafik-dropdown-item .repeat-icon { font-size: 1rem; line-height: 1; }
        .grafik-legenda { display: flex; flex-wrap: wrap; gap: 8px; }
        .grafik-legenda-item { display: inline-flex; align-items: center; gap: 4px; font-size: 0.72rem; }
        .grafik-legenda-color { width: 12px; height: 12px; border-radius: 2px; display: inline-block; }
        .szef-star { color: #f59e0b; margin-right: 1px; }
        .grafik-table tr.not-glowny .col-name { color: #9ba3af; font-style: italic; }
        .day-num { font-size: 0.68rem; font-weight: 600; line-height: 1.1; }
        .day-name { font-size: 0.55rem; color: #999; line-height: 1.1; }

        /* month picker */
        .month-picker-trigger:hover { background: #f1f5f9; }
        .month-picker-dropdown {
            display: none; position: absolute; z-index: 200; top: 100%; left: 50%; transform: translateX(-50%);
            background: #fff; border: 1px solid #d9dbde; border-radius: 6px;
            box-shadow: 0 6px 16px rgba(0,0,0,.15); padding: 8px; width: 210px; margin-top: 4px;
        }
        .month-picker.open .month-picker-dropdown { display: block; }
        .mpd-year-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        .mpd-year-nav { text-decoration: none; color: #206bc4; font-weight: 700; font-size: 1rem; padding: 0 6px; line-height: 1; }
        .mpd-year-nav:hover { color: #1a56a0; }
        .mpd-year-label { font-size: .85rem; }
        .mpd-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 3px; }
        .mpd-item {
            text-align: center; padding: 5px 0; border-radius: 4px; font-size: .78rem;
            text-decoration: none; color: #333; font-weight: 500;
        }
        .mpd-item:hover { background: #e8f0fe; color: #206bc4; }
        .mpd-item.active { background: #206bc4; color: #fff; font-weight: 700; }

        @media print {
            .grafik-nav, .no-print { display: none !important; }
            .grafik-table .col-name { position: static; }
        }
    </style>
{% endblock %}

{% block body %}
{% if brakDepartamentu %}
    <div class="card">
        <div class="card-body text-center text-muted py-5">
            <h3>Nie przypisano do żadnego departamentu</h3>
            <p>Skontaktuj się z administratorem, aby zostać przypisanym do departamentu.</p>
        </div>
    </div>
{% else %}
    <div class="card" data-controller="grafik"
         data-grafik-upsert-url-value="{{ path('grafik_upsert_wpis') }}"
         data-grafik-delete-url-value="{{ path('grafik_delete_wpis') }}"
         data-grafik-batch-url-value="{{ path('grafik_batch_wpis') }}"
         data-grafik-typy-zmian-value="{{ typyZmian|map(t => {id: t.id, nazwa: t.nazwa, skrot: t.skrot, kolor: t.kolor, godzinyOd: t.godzinyOd, godzinyDo: t.godzinyDo, skrotKlawiaturowy: t.skrotKlawiaturowy, tylkoGlowny: t.tylkoGlowny, szablonPodania: t.szablonPodania, szablonId: t.szablon ? t.szablon.id : null})|json_encode|e('html_attr') }}"
         data-grafik-can-edit-value="{{ canEdit ? 'true' : 'false' }}"
         data-grafik-departament-id-value="{{ departament.id }}"
         data-grafik-glowny-user-ids-value="{{ glownyUserIds|json_encode|e('html_attr') }}"
         data-grafik-dni-wolne-value="{{ []|merge(dni|filter(d => d.weekend or d.swieto)|map(d => d.numer))|json_encode|e('html_attr') }}"
         data-grafik-podanie-url-value="{{ path('grafik_podanie_form', {userId: 99999, rok: rok})|replace({'99999': '__UID__'}) }}?typZmianyId=__TZID__"
         data-grafik-podanie-pdf-url-value="{{ path('grafik_podanie_pdf', {id: 99999})|replace({'99999': '__PID__'}) }}"
         data-grafik-current-user-id-value="{{ currentUserId }}"
         data-grafik-auto-plan-url-value="{{ path('grafik_auto_plan') }}"
         data-grafik-rok-value="{{ rok }}"
         data-grafik-miesiac-value="{{ miesiac }}">
        <div class="card-header grafik-nav no-print">
            <div class="d-flex align-items-center justify-content-between w-100 flex-wrap gap-2">
                <div class="d-flex align-items-center gap-2">
                    <label class="form-label mb-0 fw-bold">Departament:</label>
                    <select class="form-select form-select-sm" style="width:auto; min-width:160px;" onchange="window.location.href='/planer/'+this.value+'/{{ rok }}/{{ miesiac }}'">
                        {% for d in dostepneDepartamenty %}
                            <option value="{{ d.id }}"{{ d.id == departament.id ? ' selected' : '' }}>{{ d.nazwa }} ({{ d.skrot }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <a href="{{ path('grafik_index', {departamentId: departament.id, rok: prevRok, miesiac: prevMiesiac}) }}" class="btn btn-sm btn-outline-secondary">&laquo;</a>
                    <div class="month-picker" style="position:relative;">
                        <span class="fw-bold month-picker-trigger" style="cursor:pointer; user-select:none; padding:2px 8px; border-radius:4px;">
                            {{ miesiacNazwa }} {{ rok }}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px; opacity:.5;">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </span>
                        <div class="month-picker-dropdown">
                            <div class="mpd-year-row">
                                <a href="#" class="mpd-year-nav" data-dir="-1">&laquo;</a>
                                <span class="mpd-year-label fw-bold">{{ rok }}</span>
                                <a href="#" class="mpd-year-nav" data-dir="1">&raquo;</a>
                            </div>
                            <div class="mpd-grid">
                                {% set nazwyMiesiecy = {1:'Sty',2:'Lut',3:'Mar',4:'Kwi',5:'Maj',6:'Cze',7:'Lip',8:'Sie',9:'Wrz',10:'Paź',11:'Lis',12:'Gru'} %}
                                {% for m, nazwa in nazwyMiesiecy %}
                                    <a href="{{ path('grafik_index', {departamentId: departament.id, rok: rok, miesiac: m}) }}"
                                       class="mpd-item{{ m == miesiac ? ' active' : '' }}" data-month="{{ m }}">{{ nazwa }}</a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <a href="{{ path('grafik_index', {departamentId: departament.id, rok: nextRok, miesiac: nextMiesiac}) }}" class="btn btn-sm btn-outline-secondary">&raquo;</a>
                </div>
                <div class="d-flex align-items-center gap-2">
                    {% if canEdit %}
                        <button type="button" class="btn btn-sm btn-outline-success"
                                data-action="grafik#autoPlan">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
                                 stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M12 8l0 4l2 2"/>
                                <path d="M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5"/>
                            </svg>
                            AUTO Plan
                        </button>
                        <a href="{{ path('grafik_dzial_pracownicy', {departamentId: departament.id}) }}" class="btn btn-sm btn-outline-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
                                 stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"/>
                                <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                <path d="M21 21v-2a4 4 0 0 0 -3 -3.85"/>
                            </svg>
                            Pracownicy
                        </a>
                    {% endif %}
                    <a href="{{ path('grafik_podanie_lista') }}" class="btn btn-sm btn-outline-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
                             stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
                            <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/>
                            <path d="M9 17h6"/>
                            <path d="M9 13h6"/>
                        </svg>
                        {% if is_granted('ROLE_ADMIN') %}Podania{% else %}Moje podania{% endif %}
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body p-0 grafik-wrap">
            <table class="grafik-table" style="--tblr-table-cell-padding:0; --bs-table-cell-padding-y:0; --bs-table-cell-padding-x:0">
                <thead>
                    <tr>
                        <th class="col-name">Pracownik</th>
                        {% for d in dni %}
                            <th class="{% if d.swieto %}holiday holiday-header{% elseif d.weekend %}weekend{% endif %}"
                                {% if d.swietoNazwa %}title="{{ d.swietoNazwa }}"{% endif %}>
                                <div class="day-num">{{ d.numer }}</div>
                                <div class="day-name">{{ d.dzienTygodnia }}</div>
                            </th>
                        {% endfor %}
                        <th class="col-dw" title="Dni wolne (typ W)">
                            <div class="day-num">DW</div>
                            <div class="day-name">{{ liczbaDniWolnych }}</div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in users %}
                        {% set u = entry.user %}
                        <tr class="{{ not entry.czyGlowny ? 'not-glowny' : '' }}">
                            <td class="col-name" title="{{ u.fullName }}{{ not entry.czyGlowny ? ' (dział dodatkowy)' : '' }}">
                                {% if entry.czySzef %}<span class="szef-star" title="Szef działu">&#9733;</span>{% endif %}
                                {{ u.fullName }}
                            </td>
                            {% for d in dni %}
                                {% set wpis = grid[u.id][d.numer] ?? null %}
                                {% set podanieId = podaniaMap[u.id ~ '-' ~ d.numer] ?? null %}
                                {% set isOwnPodanieCell = (not canEdit and u.id == currentUserId and wpis and wpis.typZmiany.szablonPodania) %}
                                <td class="gc {% if d.swieto %}holiday{% elseif d.weekend %}weekend{% endif %}"><div class="grafik-cell {{ canEdit ? 'editable' : '' }} {{ isOwnPodanieCell ? 'editable' : '' }} {{ wpis ? '' : 'gc-empty' }} {{ podanieId ? 'has-podanie' : '' }}"
                                    {% if canEdit or isOwnPodanieCell %}data-grafik-target="cell" data-user-id="{{ u.id }}" data-day="{{ d.numer }}" data-date="{{ rok }}-{{ '%02d'|format(miesiac) }}-{{ '%02d'|format(d.numer) }}"{% endif %}
                                    {% if podanieId %}data-podanie-id="{{ podanieId }}"{% endif %}
                                    {% if wpis %}style="background:{{ wpis.typZmiany.kolor }};color:{{ wpis.typZmiany.kolorTekstu }}" title="{{ wpis.typZmiany.nazwa }}{% if wpis.typZmiany.godzinyOd %} {{ wpis.typZmiany.godzinyOd }}-{{ wpis.typZmiany.godzinyDo }}{% endif %}{% if podanieId %} (podanie złożone){% endif %}"{% endif %}
                                >{{ wpis ? wpis.typZmiany.skrot : '' }}</div></td>
                            {% endfor %}
                            <td class="col-dw"><div class="grafik-cell dw-cell" data-grafik-target="dwCell" data-user-id="{{ u.id }}">{{ dniWolnePerUser[u.id] ?? 0 }}</div></td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="{{ dniWMiesiacu + 2 }}" class="text-center text-muted" style="padding:16px">Brak pracowników w tym departamencie.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="card-footer no-print">
            <div class="grafik-legenda">
                {% for typ in typyZmian %}
                    <span class="grafik-legenda-item">
                        <span class="grafik-legenda-color" style="background-color: {{ typ.kolor }};"></span>
                        <strong>{{ typ.skrot }}</strong> {{ typ.nazwa }}
                        {% if typ.godzinyOd %}{{ typ.godzinyOd }}-{{ typ.godzinyDo }}{% endif %}
                        {% if typ.skrotKlawiaturowy %}<kbd style="font-size:.6rem; margin-left:2px;">{{ typ.skrotKlawiaturowy }}</kbd>{% endif %}
                    </span>
                {% endfor %}
            </div>
        </div>
    </div>

<script>
(function() {
    var picker = document.querySelector('.month-picker');
    if (!picker || picker.dataset.bound) return;
    picker.dataset.bound = '1';

    var trigger = picker.querySelector('.month-picker-trigger');
    var yearLabel = picker.querySelector('.mpd-year-label');
    var items = picker.querySelectorAll('.mpd-item');
    var deptId = '{{ departament.id }}';
    var currentYear = {{ rok }};
    var displayYear = currentYear;

    trigger.addEventListener('click', function(e) {
        e.stopPropagation();
        picker.classList.toggle('open');
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.month-picker')) {
            picker.classList.remove('open');
        }
    });

    function updateLinks() {
        yearLabel.textContent = displayYear;
        items.forEach(function(a) {
            var m = a.dataset.month;
            a.href = '/planer/' + deptId + '/' + displayYear + '/' + m;
            if (displayYear == currentYear) {
                a.classList.toggle('active', m == '{{ miesiac }}');
            } else {
                a.classList.remove('active');
            }
        });
    }

    picker.querySelectorAll('.mpd-year-nav').forEach(function(nav) {
        nav.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            displayYear += parseInt(this.dataset.dir);
            updateLinks();
        });
    });
})();
</script>
{% endif %}
{% endblock %}
